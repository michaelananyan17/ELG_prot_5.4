<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PELE - Personalized English Learning Experience (Functional - V2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 2rem 1rem;
        }
        .app-container {
            background-color: #ffffff;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            max-width: 4xl;
            width: 100%;
            border-radius: 1rem;
            padding: 2rem 1.5rem;
        }

        /* --- Step 1/2 Styling (UPDATED from prot_2) --- */
        .card-topic, .card-format {
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            user-select: none;
            border: 3px solid transparent;
            background-color: #ffffff;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative; 
        }
        .card-topic:hover, .card-format:hover {
            box-shadow: 0 5px 20px rgba(79, 70, 229, 0.2);
        }
        .card-topic.selected, .card-format.selected {
            border-color: #4f46e5; /* Indigo-600 */
            background-color: #eef2ff; /* Indigo-50 */
            box-shadow: 0 5px 20px rgba(79, 70, 229, 0.3);
        }
        
        /* Priority number style for selected topic cards */
        .priority-number {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            background-color: #4f46e5;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* --- Step 3 Styling (CEFR Slider) --- */
        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4f46e5; /* Indigo-600 */
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            margin-top: -8px; 
        }
        .slider-thumb::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4f46e5;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ============================================================== */
        /* --- STEP 4: ASSIGNMENT STYLING (ADAPTED FROM index_prot_4.html) --- */
        /* ============================================================== */
        .assignment-block { 
            border-left: 5px solid; 
            padding: 1.5rem; 
            margin-bottom: 2rem; 
            border-radius: 0.5rem; 
            background-color: #fff; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); 
        }
        
        /* Step 4: NEW Sidebar Colors based on order (prot_4 colors) */
        .block-order-1 { border-color: #f59e0b; background-color: #fffbeb; } /* Orange */
        .block-order-2 { border-color: #10b981; background-color: #ecfdf5; } /* Green */
        .block-order-3 { border-color: #4f46e5; background-color: #eef2ff; } /* Blue */
        
        /* Unified Input Style for Writing/Vocabulary */
        .input-style { 
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #d1d5db; 
            border-radius: 0.5rem; 
            resize: vertical; 
            font-size: 1rem; 
            transition: all 0.2s; 
        }
        .input-style:focus { 
            border-color: #4f46e5; 
            box-shadow: 0 0 0 3px #c7d2fe; 
            outline: none; 
        }

        /* Grammar Practice Inline Input Container */
        .grammar-input-container { 
            display: flex; 
            align-items: center; 
            flex-wrap: wrap; 
            margin-top: 1rem; 
            line-height: 2.5; 
            font-size: 1.125rem; /* text-lg */
        }
        .grammar-input-container span {
            margin: 0 4px;
        }
        .grammar-input {
            border: 1px solid #ccc;
            padding: 4px 6px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
            color: #1e40af;
            min-width: 100px;
            flex-shrink: 0;
        }

        /* Interactive Element Styling (Multiple Choice - Keeping original prot_5_3 tile look) */
        .mc-option {
            transition: all 0.2s ease;
            cursor: pointer;
            border: 2px solid #e5e7eb; /* Light grey */
            display: flex; 
            align-items: center;
        }
        .mc-option:hover {
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }
        
        /* Visual feedback for user selection BEFORE grading */
        .mc-option.selected-user {
            background-color: #e0f2fe; /* Light blue/sky-100 for selected state */
            border-color: #3b82f6; /* Blue-500 */
        }
        /* Custom styling for the letter circle */
        .mc-option .option-letter {
            width: 24px;
            height: 24px;
            min-width: 24px; 
            min-height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #4f46e5;
            border: 2px solid #a5b4fc;
            background-color: #eef2ff;
            transition: background-color 0.2s;
        }

        /* Styling for Correct/Incorrect feedback AFTER grading */
        .mc-option.selected-correct {
            background-color: #d1fae5; /* Green 100 */
            border-color: #10b981; /* Green 500 */
        }
        .mc-option.selected-incorrect {
            background-color: #fee2e2; /* Red 100 */
            border-color: #ef4444; /* Red 500 */
        }
        /* Style for the Correct Answer when user was incorrect (Green highlight) */
        .mc-option.bg-green-200 { 
            border-color: #059669 !important; /* Deeper Green */
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="app-container">
        <div id="header-section" class="mb-8">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2 text-center">PELE Assignment Generator</h1>
            <p class="text-gray-500 text-center">Powered by OpenAI</p>
        </div>

        <div class="mb-8">
            <div class="relative pt-1">
                <div class="flex mb-2 items-center justify-between">
                    <div class="text-right">
                        <span id="progress-text" class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-indigo-600 bg-indigo-200">
                            Step 1: Get Started
                        </span>
                    </div>
                </div>
                <div class="overflow-hidden h-2 mb-4 text-xs flex rounded bg-indigo-200">
                    <div id="progress-bar" style="width: 25%" class="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-indigo-600 transition-all duration-500"></div>
                </div>
            </div>
        </div>

        <div id="step-1" class="step-content">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Welcome! Let's Get Set Up.</h2>
            <div class="p-6 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg mb-6">
                <h3 class="font-bold text-yellow-800 mb-2">Important: OpenAI API Key Required</h3>
                <p class="text-sm text-yellow-700">To generate *real* assignments, you need an API key for the OpenAI model. Paste your key below.</p>
            </div>

            <div class="mb-6">
                <label for="openai-api-key" class="block text-sm font-medium text-gray-700 mb-2">OpenAI API Key</label>
                <input type="text" id="openai-api-key" placeholder="Paste your API key here (starts with 'sk-...')" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out">
            </div>

            <div class="mt-8 flex justify-end">
                <button id="step-1-next" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out disabled:opacity-50" disabled>
                    Next: Topic Selection ‚Üí
                </button>
            </div>
        </div>


        <div id="step-2" class="step-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Step 2: Choose Your Topic</h2>
                <input type="file" id="upload-topic-input" accept=".txt,.pdf" class="hidden">
                <button id="upload-topic-btn" class="flex items-center px-4 py-2 text-indigo-600 border border-indigo-600 rounded-lg font-semibold hover:bg-indigo-50 transition duration-150 ease-in-out">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Upload Topic
                </button>
            </div>

            <p class="text-gray-600 mb-4">Select **1 or 2 topics**. The order of selection determines the priority for content generation.</p>

            <div class="flex gap-2 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <input type="text" id="custom-topic-text" placeholder="Search a custom topic or keyword..." 
                       class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out">
                <button id="select-custom-topic-btn" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out disabled:opacity-50" disabled>
                    Select
                </button>
            </div>
            
            <p id="selected-topics-indicator" class="text-sm font-medium text-gray-700 mb-6">Selected Topics (Priority Order): None</p>

            <div id="topic-cards" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                </div>


            <div class="flex justify-between mt-8">
                <button id="step-2-back" class="px-6 py-3 text-gray-600 border border-gray-400 rounded-lg font-semibold hover:bg-gray-100 transition duration-150 ease-in-out">
                    ‚Üê Back to API Setup
                </button>
                <button id="step-2-next" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out disabled:opacity-50" disabled>
                    Next: Assignment Type ‚Üí
                </button>
            </div>
        </div>

        <div id="step-3" class="step-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Step 3: Format & Difficulty</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Assignment Format</h3>
                    <div id="format-cards" class="grid grid-cols-2 gap-4">
                        </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Difficulty Level (CEFR)</h3>
                    
                    <div class="p-6 bg-indigo-50 rounded-lg shadow-inner">
                        <div class="flex justify-between text-sm font-medium text-indigo-700 mb-4">
                            <span id="cefr-display" class="text-2xl font-bold">A1</span>
                            <span id="level-description-short" class="mt-1">Beginner</span>
                        </div>
                        <input type="range" min="1" max="6" value="3" id="cefr-slider" 
                               class="w-full h-2 bg-indigo-300 rounded-lg appearance-none cursor-pointer slider-thumb">
                        <div class="flex justify-between text-xs mt-2 text-indigo-700 font-medium">
                            <span>A1</span>
                            <span>A2</span>
                            <span>B1</span>
                            <span>B2</span>
                            <span>C1</span>
                            <span>C2</span>
                        </div>
                    </div>

                    <div class="mt-6">
                        <div id="description-toggle-header" class="flex items-center justify-between cursor-pointer p-3 rounded-lg bg-gray-100 hover:bg-gray-200 transition">
                            <span class="font-medium text-gray-700">What does this level mean?</span>
                            <span id="toggle-icon" class="text-gray-500 transform transition-transform duration-300">‚ñº</span>
                        </div>
                        <div id="level-description-full" class="p-4 bg-white border border-t-0 rounded-b-lg text-sm text-gray-600 hidden">
                            </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-between mt-8">
                <button id="step-3-back" class="px-6 py-3 text-indigo-600 border border-indigo-600 rounded-lg font-semibold hover:bg-indigo-50 transition duration-150 ease-in-out">
                    Back (Step 2)
                </button>
                <button id="step-3-next-generate" class="px-8 py-3 bg-green-600 text-white font-bold rounded-lg shadow-xl hover:bg-green-700 transition duration-150 ease-in-out disabled:opacity-50" disabled>
                    Generate Assignments
                </button>
            </div>
        </div>

        <div id="step-4" class="step-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Step 4: Generated Assignments</h2>

            <div id="generation-loading" class="text-center p-12 border border-dashed border-gray-300 rounded-lg hidden">
                <div class="spinner mx-auto mb-4"></div>
                <p class="text-gray-600 font-semibold text-lg">
                    Generating your personalized English assignments using the LLM...
                </p>
                <p class="text-sm text-gray-500 mt-2">This may take up to 30 seconds depending on the complexity.</p>
            </div>

            <div id="generation-error" class="bg-red-50 border-l-4 border-red-400 text-red-700 p-4 rounded hidden" role="alert">
                <p class="font-bold">Generation Failed</p>
                <p id="error-message" class="text-sm">An unknown error occurred while contacting the LLM.</p>
            </div>

            <div id="assignment-results" class="space-y-8 hidden">
                </div>
            
            <div id="grading-summary" class="hidden mt-8 p-6 bg-indigo-50 rounded-lg border border-indigo-200 shadow-md">
                <h3 class="text-xl font-bold text-indigo-800">Review Summary</h3>
                <p class="text-lg text-indigo-600 mt-1">Score on Graded Questions: <span id="current-score" class="font-extrabold text-2xl">0/0</span></p>
                <p id="grading-message" class="text-sm text-indigo-700"></p>
            </div>

            <div class="flex justify-between mt-8">
                <button id="step-4-back-to-prev" class="px-6 py-3 text-indigo-600 border border-indigo-600 rounded-lg font-semibold hover:bg-indigo-50 transition duration-150 ease-in-out">
                    Change Criteria
                </button>
                <button id="submit-assignments" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out disabled:opacity-50" disabled>
                    Grade & Review (Step 5)
                </button>
            </div>
        </div>

        <div id="step-5" class="step-content hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Step 5: Final Review & Export</h2>
            
            <div class="p-6 bg-green-50 border-l-4 border-green-400 text-green-700 rounded-lg mb-6">
                <p class="font-bold">Success!</p>
                <p class="text-sm">Your real, custom-generated assignments are ready for use. You can now copy or export them.</p>
            </div>

            <div id="final-review-content" class="p-6 border border-gray-200 rounded-lg bg-white shadow-sm space-y-4">
                <h3 class="text-xl font-semibold text-gray-700">Assignments Summary</h3>
                <div id="final-assignment-text" class="whitespace-pre-wrap text-gray-700 text-sm">
                    </div>
                <button onclick="copyToClipboard('final-assignment-text')" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg text-sm hover:bg-gray-300 transition duration-150 ease-in-out mt-4">
                    Copy All Assignments
                </button>
            </div>

            <div class="flex justify-between mt-8">
                <button id="step-5-back-to-prev" class="px-6 py-3 text-indigo-600 border border-indigo-600 rounded-lg font-semibold hover:bg-indigo-50 transition duration-150 ease-in-out">
                    Back (Step 4)
                </button>
                <button id="step-5-back-to-start" class="px-6 py-3 bg-gray-800 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition duration-150 ease-in-out">
                    Finish & Restart
                </button>
            </div>
        </div>
    </div>

    <script>
        // =====================================================================================================
        // GLOBAL CONFIGURATION & STATE
        // =====================================================================================================
        // IMPORTANT: The user must paste their key here
        let API_KEY = ''; 
        // OpenAI Configuration
        const OPENAI_MODEL = 'gpt-3.5-turbo-1106'; // A model supporting the JSON mode
        const OPENAI_URL = 'https://api.openai.com/v1/chat/completions';

        const appState = {
            currentStep: 1,
            selectedTopicIds: [], 
            selectedFormatIds: [],
            cefrLevel: 'B1', 
            uploadedTopic: null, 
            generatedAssignments: [],
            userAnswers: [], 
        };

        const TOPIC_POOL = [
            { id: 1, name: 'AI & ML', icon: 'ü§ñ', category: 'Technology' },
            { id: 2, name: 'Climate Change', icon: 'üåé', category: 'Science' },
            { id: 3, name: 'Art History', icon: 'üé®', category: 'Culture' },
            { id: 4, name: 'Ancient History', icon: 'üèõÔ∏è', category: 'History' },
            { id: 5, name: 'Financial Markets', icon: 'üí∞', category: 'Finance' },
            { id: 6, name: 'Poetry & Literature', icon: 'üìú', category: 'Culture' },
        ];

        const FORMATS = [
            { id: 'ft1', name: 'Writing Prompt', type: 'WritingPrompt', icon: '‚úçÔ∏è', description: 'Generates an essay/response topic based on the context (Ungraded)' },
            { id: 'ft2', name: 'Grammar Practice', type: 'GrammarPractice', icon: 'üß†', description: 'Generates sentences with blanks for conjunction or syntax practice (Graded)' },
            { id: 'ft3', name: 'Vocabulary Words', type: 'VocabularyWords', icon: 'üìö', description: 'Generates new words with context, requiring students to use them in sentences (Ungraded)' },
            { id: 'ft4', name: 'Multiple Choice', type: 'MultipleChoice', icon: '‚úÖ', description: 'Generates questions with four potential answers, with only one correct answer (Graded)' },
        ];

        const CEFR_LEVELS = {
            'A1': { short: 'Beginner', full: 'Can understand and use familiar everyday expressions and very basic phrases.' },
            'A2': { short: 'Elementary', full: 'Can understand sentences and frequently used expressions related to areas of most immediate relevance.' },
            'B1': { short: 'Intermediate', full: 'Can understand the main points of clear standard input on familiar matters regularly encountered in work, school, leisure, etc.' },
            'B2': { short: 'Upper Intermediate', full: 'Can understand the main ideas of complex text on both concrete and abstract topics, including technical discussions in their field of specialization.' },
            'C1': { short: 'Advanced', full: 'Can understand a wide range of demanding, longer texts, and recognize implicit meaning. Can express him/herself fluently and spontaneously.' },
            'C2': { short: 'Proficiency', full: 'Can understand virtually everything heard or read. Can express him/herself spontaneously, very fluently and precisely.' },
        };

        // =====================================================================================================
        // UTILITY FUNCTIONS
        // =====================================================================================================

        function getElement(id) {
            return document.getElementById(id);
        }

        function showStep(stepNumber) {
            // Hide all step content
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            
            // Show current step
            const currentStepEl = getElement(`step-${stepNumber}`);
            if (currentStepEl) {
                currentStepEl.classList.remove('hidden');
            }

            // Update progress bar
            updateProgressBar(stepNumber);
            appState.currentStep = stepNumber;
        }

        function updateProgressBar(step) {
            const width = step * 25;
            const progressText = [
                'Step 1: Get Started', 
                'Step 2: Topic Selection', 
                'Step 3: Criteria & Difficulty', 
                'Step 4: Assignments', 
                'Step 5: Review & Export'
            ][step - 1] || 'Completed';
            
            getElement('progress-bar').style.width = width + '%';
            getElement('progress-text').textContent = progressText;
        }

        function updateButtonStates() {
            // Step 1: API Key validation
            const apiKey = getElement('openai-api-key').value.trim();
            API_KEY = apiKey;
            getElement('step-1-next').disabled = apiKey.length === 0;

            // Step 2: Topic validation
            const hasTopic = appState.selectedTopicIds.length > 0;
            getElement('step-2-next').disabled = !hasTopic;
            
            // Custom Topic Search Select button
            const customTopicInput = getElement('custom-topic-text').value.trim();
            getElement('select-custom-topic-btn').disabled = !customTopicInput;
            
            // Update topic selection limit visual
            updateTopicSelectionVisuals();

            // Step 3: Format validation
            const hasFormat = appState.selectedFormatIds.length > 0;
            getElement('step-3-next-generate').disabled = !hasFormat;

            // Step 4: Assignment Review validation
            getElement('submit-assignments').disabled = appState.generatedAssignments.length === 0;
        }

        function updateLevel(sliderValue) {
            const levelIndex = parseInt(sliderValue);
            const levelKeys = ['A1', 'A2', 'B1', 'B2', 'C1', 'C2'];
            const level = levelKeys[levelIndex - 1];
            
            appState.cefrLevel = level;
            const levelData = CEFR_LEVELS[level];

            getElement('cefr-display').textContent = level;
            getElement('level-description-short').textContent = levelData.short;
            getElement('level-description-full').innerHTML = `
                <p class="font-bold mb-2">${level} - ${levelData.short}</p>
                <p>${levelData.full}</p>
            `;
            
            updateButtonStates();
        }

        function toggleDescription() {
            const desc = getElement('level-description-full');
            const icon = getElement('toggle-icon');
            const isHidden = desc.classList.contains('hidden');
            
            desc.classList.toggle('hidden', !isHidden);
            icon.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
        }
        
        // =====================================================================================================
        // STEP 4 LOGIC (MODIFIED VISUALS)
        // =====================================================================================================

        // NEW: Function to handle user input changes and store them in appState.userAnswers
        function handleUserAnswer(assignmentIndex, inputElement, answerType) {
            appState.userAnswers[assignmentIndex] = appState.userAnswers[assignmentIndex] || {};
            
            if (answerType === 'MultipleChoice') {
                // For MC, store the value (which is the index of the selected option)
                appState.userAnswers[assignmentIndex].answer = parseInt(inputElement.value);
                // Visual feedback for MC selection (remove from all, add to selected)
                document.querySelectorAll(`#assignment-card-${assignmentIndex} .mc-option`).forEach(opt => {
                    opt.classList.remove('selected-user');
                });
                inputElement.closest('label').classList.add('selected-user');

            } else {
                // For Grammar/Writing/Vocabulary, store the text value
                appState.userAnswers[assignmentIndex].answer = inputElement.value;
            }
            
            // Enable the Submit button after the first answer (heuristic)
            const hasAnyAnswer = appState.userAnswers.some(ans => ans && ans.answer !== undefined && ans.answer !== '' && ans.answer !== null);
            getElement('submit-assignments').disabled = !hasAnyAnswer;
        }

        /**
         * Renders the interactive HTML for a single assignment based on its type.
         * USES NEW CSS CLASSES FROM index_prot_4.html.
         */
        function renderInteractiveElement(type, assignment, index) {
            const assignmentId = `assignment-${index}`;
            const originalContent = assignment.content;
            let html = '';

            // 1. Multiple Choice (KEEPING prot_5_3 TILE VISUAL)
            if (type === 'MultipleChoice') {
                html += '<p class="text-gray-700 font-medium mb-3">Select the best option:</p>';
                html += `<p class="text-lg font-semibold text-gray-900 mb-4">${assignment.question}</p>`;
                
                html += '<div class="space-y-3">';
                
                assignment.options.forEach((option, optionIndex) => {
                    const optionId = `${assignmentId}-option-${optionIndex}`;
                    const isSelected = appState.userAnswers[index]?.answer == optionIndex;
                    
                    // Use the tile-based design from prot_5_3.html
                    html += `<label for="${optionId}" class="mc-option p-4 rounded-xl cursor-pointer ${isSelected ? 'selected-user' : ''}">
                        <input type="radio" id="${optionId}" name="${assignmentId}-mc-group" value="${optionIndex}" class="hidden" 
                            onchange="handleUserAnswer(${index}, this, '${type}')" ${isSelected ? 'checked' : ''}>
                        <div class="flex items-start w-full">
                            <span class="option-letter mr-3">
                                ${String.fromCharCode(65 + optionIndex)} 
                            </span>
                            <span class="text-gray-800 pt-0.5 flex-1">${option}</span>
                        </div>
                    </label>`;
                });
                html += '</div>';
            } 
            
            // 2. Grammar Practice (USING prot_4 INLINE VISUAL CONCEPT)
            else if (type === 'GrammarPractice' && originalContent) {
                // Assume LLM returns a sentence with ONE "___" placeholder.
                const parts = originalContent.split('___');
                const answerValue = appState.userAnswers[index]?.answer || '';

                html += '<p class="text-gray-700 font-medium mb-3">Complete the sentence:</p>';
                html += `<div class="grammar-input-container">`;
                
                // Output text before the blank
                if (parts[0]) {
                    html += `<span>${parts[0].trim()}</span>`;
                }
                
                // Output the input field (using prot_4 grammar-input class)
                html += `<input type="text" id="${assignmentId}-input" placeholder="answer" 
                            class="grammar-input" 
                            oninput="handleUserAnswer(${index}, this, '${type}')" 
                            value="${answerValue}">`;
                
                // Output text after the blank
                if (parts[1]) {
                    html += `<span>${parts[1].trim()}</span>`;
                }

                html += `</div>`;

                // Add a visual helper for the user
                html += `<p class="text-sm text-gray-500 mt-4 italic">Fill in the blank with the correct word or phrase.</p>`;
            } 
            
            // 3. Writing Prompt (USING prot_4 input-style)
            else if (type === 'WritingPrompt') {
                html += '<p class="text-gray-700 font-medium mb-3">**Instructions:**</p>';
                html += `<p class="text-sm text-gray-500 italic mb-4 whitespace-pre-wrap">${assignment.content}</p>`; // The prompt text
                
                html += '<h4 class="text-sm font-bold text-gray-800 mt-4 mb-2">Your Response:</h4>';
                html += `<textarea id="${assignmentId}-input" rows="8" placeholder="Start writing here..." 
                            class="input-style" 
                            oninput="handleUserAnswer(${index}, this, '${type}')">${appState.userAnswers[index]?.answer || ''}</textarea>`;
            } 
            
            // 4. Vocabulary Words (USING prot_4 input-style)
            else if (type === 'VocabularyWords') {
                html += `<p class="text-gray-700 font-medium mb-3">**Instructions:** ${assignment.question || ''}</p>`; 
                html += `<p class="text-sm text-gray-500 italic mb-4 whitespace-pre-wrap">${assignment.content}</p>`; // The instructions/definitions
                
                html += '<h4 class="text-sm font-bold text-gray-800 mt-4 mb-2">Your Sentence/Response:</h4>';
                html += `<textarea id="${assignmentId}-input" rows="5" placeholder="Write your sentence(s) here, incorporating the vocabulary..." 
                            class="input-style" 
                            oninput="handleUserAnswer(${index}, this, '${type}')">${appState.userAnswers[index]?.answer || ''}</textarea>`;
            }

            return html;
        }

        // MODIFIED: This function now uses the new assignment-block visual structure from prot_4.html
        function renderAssignments() {
            const container = getElement('assignment-results');
            const sidebarColors = ['block-order-1', 'block-order-2', 'block-order-3']; // Colors from prot_4.html

            let html = appState.generatedAssignments.map((assignment, index) => {
                const assignmentId = `assignment-${index}`;
                const type = assignment.type;
                const colorClass = sidebarColors[index % 3]; // Cycles through the 3 colors
                
                // Find the topic name for display
                const selectedTopic = TOPIC_POOL.find(t => t.id === appState.selectedTopicIds[0]) || { name: 'Custom' };
                const topicName = assignment.topicName || selectedTopic.name; 

                // **NEW: Use the assignment-block and color class from prot_4**
                let assignmentHtml = `
                    <div id="assignment-card-${index}" class="assignment-block ${colorClass}" data-assignment-type="${type}">
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">${assignment.title}</h3>
                        <div class="flex items-center space-x-2 mb-4">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-indigo-200 text-indigo-800">${assignment.type}</span>
                            <span class="px-3 py-1 text-xs font-semibold rounded-full bg-indigo-200 text-indigo-800">${appState.cefrLevel} Level</span>
                            <span class="text-xs text-gray-500 italic">Topic: ${topicName}</span>
                        </div>
                        
                        ${renderInteractiveElement(type, assignment, index)}

                        <div id="feedback-${index}" class="hidden"></div>
                    </div>
                `;
                return assignmentHtml;
            }).join('');

            container.innerHTML = html;
            container.classList.remove('hidden');
            getElement('submit-assignments').disabled = false; // Enable submit on generation completion
        }

        // =====================================================================================================
        // REST OF THE FUNCTIONAL LOGIC (UNMODIFIED)
        // =====================================================================================================

        function toggleSelection(id, type) {
            if (type !== 'topic') {
                const stateArray = appState.selectedFormatIds;
                const cardElement = getElement(`${type}-${id}`);
                const index = stateArray.indexOf(id);

                if (index > -1) { 
                    stateArray.splice(index, 1);
                    cardElement.classList.remove('selected');
                } else { 
                    stateArray.push(id);
                    cardElement.classList.add('selected');
                }
                updateButtonStates();
                return;
            }

            const stateArray = appState.selectedTopicIds;
            const cardElement = getElement(`topic-${id}`);
            const index = stateArray.indexOf(id);
            
            if (index > -1) { 
                stateArray.splice(index, 1);
                cardElement.classList.remove('selected');
                const priorityNum = cardElement.querySelector('.priority-number');
                if (priorityNum) priorityNum.remove();
            } else if (stateArray.length < 2) { 
                stateArray.push(id);
                cardElement.classList.add('selected');
            } else {
                alert("You can select a maximum of 2 topics.");
                return;
            }
            renderCards(); 
            updateButtonStates();
        }

        function updateTopicSelectionVisuals() {
            const names = appState.selectedTopicIds.map(id => {
                const topic = TOPIC_POOL.find(t => t.id === id);
                return topic ? topic.name : 'Custom Upload/Input';
            });
            getElement('selected-topics-indicator').innerHTML = 'Selected Topics (Priority Order): <span class="font-bold text-indigo-600">' + (names.join(' | ') || 'None') + '</span>';
            
            // Update priority numbers dynamically
            appState.selectedTopicIds.forEach((id, index) => {
                const cardElement = getElement(`topic-${id}`);
                if (cardElement) {
                    let priorityNum = cardElement.querySelector('.priority-number');
                    if (!priorityNum) {
                        priorityNum = document.createElement('div');
                        priorityNum.classList.add('priority-number');
                        cardElement.appendChild(priorityNum);
                    }
                    priorityNum.textContent = index + 1;
                }
            });
        }

        function handleCustomTopicSelect() {
            const topicText = getElement('custom-topic-text').value.trim();
            if (!topicText) return;
            
            const newId = `custom-${Date.now()}`;
            const newTopic = { id: newId, name: topicText, icon: 'üí°', category: 'User Input' };

            // 1. Remove old custom topic if it exists (only one custom topic allowed for simplicity)
            TOPIC_POOL = TOPIC_POOL.filter(t => typeof t.id !== 'string' || t.id.startsWith('uploaded'));
            appState.selectedTopicIds = appState.selectedTopicIds.filter(id => typeof id !== 'string' || id.startsWith('uploaded'));
            
            // 2. Add the new custom topic and select it
            TOPIC_POOL.unshift(newTopic);
            
            if (appState.selectedTopicIds.length >= 2) {
                appState.selectedTopicIds.pop(); 
            }
            appState.selectedTopicIds.push(newId);

            getElement('custom-topic-text').value = '';
            renderCards();
            updateButtonStates();
        }

        function handleUploadTopic(event) {
            const file = event.target.files[0];
            if (!file) return;

            const uploadedId = `uploaded-${Date.now()}`;
            const newTopic = { id: uploadedId, name: file.name, icon: 'üìÑ', category: 'Uploaded File', content: '' };

            const reader = new FileReader();
            reader.onload = function(e) {
                newTopic.content = e.target.result;
                appState.uploadedTopic = newTopic;

                // 1. Remove old uploaded topic card from TOPIC_POOL and selected list if it exists
                TOPIC_POOL = TOPIC_POOL.filter(t => typeof t.id !== 'string' || !t.id.startsWith('uploaded'));
                appState.selectedTopicIds = appState.selectedTopicIds.filter(id => typeof id !== 'string' || !id.startsWith('uploaded'));

                // 2. Add the new uploaded topic to the pool
                TOPIC_POOL.unshift(newTopic);
                
                // 3. Select the new topic card (handles limit/priority)
                if (appState.selectedTopicIds.length >= 2) {
                    appState.selectedTopicIds.pop(); 
                }
                appState.selectedTopicIds.push(uploadedId); 

                // 4. Re-render cards and update state
                renderCards();
                updateButtonStates();
                event.target.value = null;
            };
            reader.readAsText(file); 
        }

        function renderCards() {
            const topicContainer = getElement('topic-cards');
            topicContainer.innerHTML = TOPIC_POOL.map(t => {
                const isSelected = appState.selectedTopicIds.includes(t.id);
                const category = t.category || 'Custom'; 
                const idString = typeof t.id === 'number' ? t.id : `'${t.id}'`;
                const rank = isSelected ? appState.selectedTopicIds.indexOf(t.id) + 1 : '';

                return `
                    <div id="topic-${t.id}" class="card-topic p-4 rounded-xl flex flex-col items-center text-center ${isSelected ? 'selected' : ''}" onclick="toggleSelection(${idString}, 'topic')">
                        <span class="text-3xl mb-1">${t.icon}</span>
                        <h3 class="font-semibold text-gray-800">${t.name}</h3>
                        <p class="text-xs text-gray-500 uppercase font-medium">${category}</p>
                        ${isSelected ? `<div class="priority-number">${rank}</div>` : ''}
                    </div>
                `;
            }).join('');

            const formatContainer = getElement('format-cards');
            formatContainer.innerHTML = FORMATS.map(f => {
                const isSelected = appState.selectedFormatIds.includes(f.id);
                return `
                    <div id="format-${f.id}" class="card-format p-4 rounded-xl text-center flex flex-col justify-center ${isSelected ? 'selected' : ''}" onclick="toggleSelection('${f.id}', 'format')">
                        <span class="text-3xl mb-1">${f.icon}</span>
                        <h3 class="font-semibold text-gray-800">${f.name}</h3>
                        <p class="text-xs text-gray-500 mt-1">${f.description}</p>
                    </div>
                `;
            }).join('');
        }
        
        // --- API & Generation Logic ---

        function buildOpenAIPayload() {
            const selectedTopics = appState.selectedTopicIds.map(id => TOPIC_POOL.find(t => t.id === id));
            const selectedFormats = appState.selectedFormatIds.map(id => FORMATS.find(f => f.id === id));

            const formatTypes = selectedFormats.map(f => f.type);
            
            // Build the topic context string
            let topicContext = selectedTopics.map((topic, index) => {
                let context = `${index + 1}. Topic: ${topic.name}`;
                // If an uploaded file is the first topic, use its content as the source text
                if (index === 0 && topic.id.startsWith('uploaded') && topic.content) {
                    context += `. Source Text: ${topic.content.substring(0, 500)}... (Full text provided for context)`;
                }
                return context;
            }).join('\n');

            const systemPrompt = `You are an expert English language assignment generator. Your task is to create ${selectedFormats.length} highly personalized English learning assignments based on the user's detailed criteria. The user requires the output to be a single, raw JSON object that conforms EXACTLY to the following structure. DO NOT include any explanatory text, markdown, or preamble/postamble outside of the JSON block.
            
            JSON Structure: { "assignments": [ { "title": "A concise title for the assignment.", "type": "The exact assignment type, MUST be one of: ${formatTypes.join(', ')}", "content": "The full instructions or body text for the student. Use \\n for line breaks.", "question": "The specific question asked to the student (e.g., 'Fill in the blank: ...'). Same as 'content' if content is simple.", "correctAnswer": "The single correct answer text (for GrammarPractice). Null otherwise.", "options": "An array of 4 options (strings) for MultipleChoice. Null otherwise.", "correctAnswerIndex": "The 0-indexed position of the correct option in the 'options' array (for MultipleChoice). Null otherwise." }, ... (one object for each requested assignment format) ] }
            
            Specific content rules:
            - **WritingPrompt/VocabularyWords**: Use the 'content' field for the prompt/task. Set correctAnswer/options/correctAnswerIndex to null.
            - **GrammarPractice**: Use 'content' for the sentence with a blank/placeholder (___). The blank must be created using exactly three underscores (___). The 'correctAnswer' must be the exact word/phrase that fills that blank. Set options/correctAnswerIndex to null.
            - **MultipleChoice**: Ensure a clear 'question' and 4 distinct 'options'. Set 'correctAnswer' to null.
            
            Criteria:
            - **Difficulty Level (CEFR)**: ${appState.cefrLevel}
            - **Topics (Context)**: ${topicContext}
            - **Assignment Formats**: ${selectedFormats.map(f => f.name).join(', ')}`;

            return {
                model: OPENAI_MODEL,
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: `Generate the ${selectedFormats.length} assignments now.` }
                ],
                response_format: { type: "json_object" },
                temperature: 0.7,
            };
        }

        async function fetchOpenAI(payload, maxRetries = 3) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(OPENAI_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_KEY}` 
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 401) {
                        throw new Error("Unauthorized (401). Please check if your OpenAI API Key is valid and correctly entered.");
                    }
                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error(`Attempt ${attempt + 1} failed:`, errorBody);
                        throw new Error(`OpenAI API error: ${response.status} - ${errorBody.error?.message || 'Unknown error'}`);
                    }

                    const result = await response.json();
                    return result;
                } catch (error) {
                    if (attempt < maxRetries - 1) {
                        const delay = Math.pow(2, attempt) * 2000; 
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`Failed to communicate with OpenAI after ${maxRetries} attempts. Details: ${error.message}`);
                    }
                }
            }
        }

        function processGeneratedText(apiResponse) {
            try {
                const textPart = apiResponse?.choices?.[0]?.message?.content;
                if (!textPart) {
                    throw new Error("OpenAI response was empty or malformed.");
                }
                const jsonResponse = JSON.parse(textPart);
                if (!jsonResponse.assignments || !Array.isArray(jsonResponse.assignments)) {
                    throw new Error("JSON structure is incorrect. Expected { 'assignments': [...] }.");
                }
                
                // Add assignment type (which is used in the rendering/grading) and topic name
                jsonResponse.assignments.forEach(a => {
                    a.topicName = TOPIC_POOL.find(t => t.id === appState.selectedTopicIds[0])?.name || 'Custom';
                });

                appState.generatedAssignments = jsonResponse.assignments;
                appState.userAnswers = new Array(jsonResponse.assignments.length).fill(null).map(() => ({ answer: '' })); // Reset user answers
                
            } catch (error) {
                console.error("Error processing generated text:", error);
                throw new Error("The LLM returned a non-parsable or non-compliant JSON format. Please try again or check your API key.");
            }
        }

        async function generateAssignments() {
            try {
                const payload = buildOpenAIPayload();
                const response = await fetchOpenAI(payload);
                processGeneratedText(response);

                getElement('generation-loading').classList.add('hidden');
                renderAssignments();
                showStep(4);
            } catch (error) {
                console.error("Fatal Error in generation:", error);
                getElement('generation-loading').classList.add('hidden');
                getElement('generation-error').classList.remove('hidden');
                getElement('error-message').textContent = error.message;
            } finally {
                getElement('step-4-back-to-prev').disabled = false;
            }
        }

        async function startGeneration() {
            // Check for API Key again
            if (!API_KEY) {
                alert("Please go back to Step 1 and provide your OpenAI API Key.");
                return;
            } else {
                getElement('generation-error').classList.add('hidden');
            }

            // Show Step 4 and the loading state
            showStep(4);
            getElement('assignment-results').classList.add('hidden');
            getElement('grading-summary').classList.add('hidden');
            getElement('generation-error').classList.add('hidden');
            getElement('generation-loading').classList.remove('hidden');

            // Disable buttons during generation
            getElement('step-4-back-to-prev').disabled = true;
            getElement('submit-assignments').disabled = true;

            await generateAssignments();
        }

        // NEW: Grading Function
        function gradeAssignments() {
            let correctCount = 0;
            let totalGradable = 0;
            let finalAssignmentText = '';

            appState.generatedAssignments.forEach((assignment, index) => {
                const userAnswer = appState.userAnswers[index]?.answer || '';
                const feedbackElement = getElement(`feedback-${index}`);
                const cardElement = getElement(`assignment-card-${index}`);
                const type = assignment.type;
                let isCorrect = false;

                // Reset state
                feedbackElement.classList.add('hidden');
                feedbackElement.className = 'text-sm mt-4 p-3 rounded-lg border-l-4'; 

                // Clear all prior MC selection coloring
                document.querySelectorAll(`#assignment-card-${index} .mc-option`).forEach(opt => {
                    opt.classList.remove('selected-correct', 'selected-incorrect', 'selected-user', 'bg-green-200');
                    opt.querySelector('input').checked = false; // Uncheck the radio buttons
                });
                
                // Re-check the user's selected option to prepare for grading visuals
                if (userAnswer !== '') {
                    // This is only for MC where the answer is the index
                    if (type === 'MultipleChoice') {
                        const selectedOptionInput = document.querySelector(`#assignment-card-${index} input[value="${userAnswer}"]`);
                        if (selectedOptionInput) {
                            selectedOptionInput.checked = true;
                            selectedOptionInput.closest('label').classList.add('selected-user');
                        }
                    }
                }


                if (type === 'MultipleChoice') {
                    totalGradable++;
                    const correctIndex = assignment.correctAnswerIndex;
                    const correctOptionElement = document.querySelector(`#assignment-card-${index} input[value="${correctIndex}"]`).closest('label');

                    if (userAnswer !== '') {
                        isCorrect = parseInt(userAnswer) === correctIndex;
                        
                        if (isCorrect) {
                            correctOptionElement.classList.add('selected-correct');
                            correctCount++;
                            feedbackElement.textContent = "‚úÖ Correct! Great job!";
                            feedbackElement.classList.add('bg-green-100', 'text-green-700', 'border-green-500');
                        } else {
                            const selectedOptionElement = document.querySelector(`#assignment-card-${index} input[value="${userAnswer}"]`).closest('label');
                            selectedOptionElement.classList.remove('selected-user'); // Remove neutral selection color
                            selectedOptionElement.classList.add('selected-incorrect');
                            correctOptionElement.classList.add('bg-green-200'); // Highlight the correct answer
                            feedbackElement.textContent = `‚ùå Incorrect. The correct answer was: ${assignment.options[correctIndex]}`;
                            feedbackElement.classList.add('bg-red-100', 'text-red-700', 'border-red-500');
                        }
                    } else {
                        // Not attempted
                        feedbackElement.textContent = `‚ö†Ô∏è Not attempted. The correct answer was: ${assignment.options[correctIndex]}`;
                        feedbackElement.classList.add('bg-yellow-100', 'text-yellow-700', 'border-yellow-500');
                        correctOptionElement.classList.add('bg-green-200'); // Highlight the correct answer
                    }

                } else if (type === 'GrammarPractice') {
                    totalGradable++;
                    const correctAnswer = assignment.correctAnswer.trim().toLowerCase();
                    const userAnswerLower = (userAnswer + '').trim().toLowerCase(); // Ensure string comparison

                    isCorrect = userAnswerLower === correctAnswer;

                    if (userAnswer !== '') {
                        if (isCorrect) {
                            correctCount++;
                            feedbackElement.textContent = "‚úÖ Correct! The sentence is grammatically sound.";
                            feedbackElement.classList.add('bg-green-100', 'text-green-700', 'border-green-500');
                        } else {
                            feedbackElement.textContent = `‚ùå Incorrect. Expected answer: "${assignment.correctAnswer}". Your answer: "${userAnswer}".`;
                            feedbackElement.classList.add('bg-red-100', 'text-red-700', 'border-red-500');
                        }
                    } else {
                        // Not attempted
                        feedbackElement.textContent = `‚ö†Ô∏è Not attempted. The correct answer was: "${assignment.correctAnswer}".`;
                        feedbackElement.classList.add('bg-yellow-100', 'text-yellow-700', 'border-yellow-500');
                    }
                } else if (type === 'WritingPrompt' || type === 'VocabularyWords') {
                    // Ungraded assignments
                    feedbackElement.textContent = "‚ÑπÔ∏è Ungraded. Your response is saved for review below.";
                    feedbackElement.classList.add('bg-gray-100', 'text-gray-600', 'border-gray-400');
                }
                
                feedbackElement.classList.remove('hidden');

                // Prepare final text: Include Prompt and User Response
                finalAssignmentText += `--- Assignment ${index + 1}: ${assignment.title} (${type}) ---\n`;
                finalAssignmentText += `Prompt:\n${assignment.content}\n\n`;
                finalAssignmentText += `User Response:\n${userAnswer || '[No Answer Provided]'}\n\n`;
                if (type === 'MultipleChoice' && assignment.correctAnswerIndex !== null) {
                    finalAssignmentText += `Grading: ${isCorrect ? 'Correct' : 'Incorrect'}. Correct Answer: ${assignment.options[assignment.correctAnswerIndex]}\n\n`;
                } else if (type === 'GrammarPractice' && assignment.correctAnswer) {
                    finalAssignmentText += `Grading: ${isCorrect ? 'Correct' : 'Incorrect'}. Correct Answer: ${assignment.correctAnswer}\n\n`;
                } else {
                    finalAssignmentText += `(Ungraded)\n\n`;
                }
            });

            // Update Grading Summary
            const scoreDisplay = getElement('current-score');
            scoreDisplay.textContent = `${correctCount}/${totalGradable}`;
            getElement('grading-summary').classList.remove('hidden');

            if (totalGradable > 0) {
                const percentage = Math.round((correctCount / totalGradable) * 100);
                getElement('grading-message').textContent = `You scored ${percentage}% on the automatically graded questions. Review the detailed feedback above for each question!`;
            } else {
                getElement('grading-message').textContent = `No automatically gradable questions were generated. Your score is based on questions of type Multiple Choice and Grammar Practice.`;
            }

            // Update final text for Step 5
            getElement('final-assignment-text').textContent = finalAssignmentText;
            showStep(5);
        }

        function submitAssignments() {
            gradeAssignments();
        }

        function copyToClipboard(elementId) {
            const content = getElement(elementId).textContent;
            navigator.clipboard.writeText(content).then(() => {
                alert('Assignments copied to clipboard!');
            }).catch(err => {
                console.error('Could not copy text: ', err);
                alert('Failed to copy text. Please copy manually.');
            });
        }
        
        // =====================================================================================================
        // INITIALIZATION
        // =====================================================================================================

        function init() {
            renderCards();

            // Set up API Key listener (Step 1)
            const apiKeyInput = getElement('openai-api-key');
            apiKeyInput.addEventListener('input', updateButtonStates);
            getElement('step-1-next').addEventListener('click', () => showStep(2));
            
            // Set up Step 2 listeners
            getElement('custom-topic-text').addEventListener('input', updateButtonStates);
            getElement('select-custom-topic-btn').addEventListener('click', handleCustomTopicSelect);
            getElement('step-2-back').addEventListener('click', () => showStep(1));
            getElement('step-2-next').addEventListener('click', () => showStep(3));
            getElement('upload-topic-btn').addEventListener('click', () => {
                getElement('upload-topic-input').click();
            });
            getElement('upload-topic-input').addEventListener('change', handleUploadTopic);

            // Set up Step 3 listeners
            const slider = getElement('cefr-slider');
            slider.addEventListener('input', (event) => updateLevel(event.target.value));
            getElement('description-toggle-header').addEventListener('click', toggleDescription);
            getElement('step-3-back').addEventListener('click', () => showStep(2));
            getElement('step-3-next-generate').addEventListener('click', startGeneration);

            // Set up Step 4 listeners
            getElement('step-4-back-to-prev').addEventListener('click', () => showStep(3));
            getElement('submit-assignments').addEventListener('click', submitAssignments);

            // Set up Step 5 listeners
            getElement('step-5-back-to-prev').addEventListener('click', () => showStep(4));
            getElement('step-5-back-to-start').addEventListener('click', () => {
                location.reload(); 
            });


            // Initial state setup
            updateLevel(slider.value); 
            showStep(1); 
            updateButtonStates(); 
        }

        window.onload = init;
    </script>
</body>
</html>
